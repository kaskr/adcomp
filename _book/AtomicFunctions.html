<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>15 Atomic functions | The comprehensive TMB documentation</title>
  <meta name="description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="generator" content="bookdown 0.35 and GitBook 2.6.7" />

  <meta property="og:title" content="15 Atomic functions | The comprehensive TMB documentation" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://kaskr.github.io/adcomp//images/cover.png" />
  <meta property="og:description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="github-repo" content="kaskr/adcomp" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="15 Atomic functions | The comprehensive TMB documentation" />
  
  <meta name="twitter:description" content="Comprehensive documentation of TMB - theory and examples." />
  <meta name="twitter:image" content="https://kaskr.github.io/adcomp//images/cover.png" />




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Validation.html"/>
<link rel="next" href="Appendix.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="Introduction.html"><a href="Introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="Tutorial.html"><a href="Tutorial.html"><i class="fa fa-check"></i><b>2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="2.1" data-path="Tutorial.html"><a href="Tutorial.html#obtaining-data-and-parameter-values-from-r"><i class="fa fa-check"></i><b>2.1</b> Obtaining data and parameter values from R</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="Tutorial.html"><a href="Tutorial.html#list-of-data-macros"><i class="fa fa-check"></i><b>2.1.1</b> List of data macros</a></li>
<li class="chapter" data-level="2.1.2" data-path="Tutorial.html"><a href="Tutorial.html#list-of-parameter-macros"><i class="fa fa-check"></i><b>2.1.2</b> List of parameter macros</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="Tutorial.html"><a href="Tutorial.html#an-extended-c-language"><i class="fa fa-check"></i><b>2.2</b> An extended C++ language</a></li>
<li class="chapter" data-level="2.3" data-path="Tutorial.html"><a href="Tutorial.html#statistical-modelling"><i class="fa fa-check"></i><b>2.3</b> Statistical modelling</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="Structure_TMB.html"><a href="Structure_TMB.html"><i class="fa fa-check"></i><b>3</b> The structure of TMB</a></li>
<li class="chapter" data-level="4" data-path="matrix_arrays.html"><a href="matrix_arrays.html"><i class="fa fa-check"></i><b>4</b> Matrices and arrays</a>
<ul>
<li class="chapter" data-level="4.1" data-path="matrix_arrays.html"><a href="matrix_arrays.html#relationship-to-r"><i class="fa fa-check"></i><b>4.1</b> Relationship to R</a></li>
<li class="chapter" data-level="4.2" data-path="matrix_arrays.html"><a href="matrix_arrays.html#relationship-to-eigen"><i class="fa fa-check"></i><b>4.2</b> Relationship to Eigen</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="R_style_distribution.html"><a href="R_style_distribution.html"><i class="fa fa-check"></i><b>5</b> R style probability distributions</a></li>
<li class="chapter" data-level="6" data-path="Densities.html"><a href="Densities.html"><i class="fa fa-check"></i><b>6</b> Multivariate distributions</a>
<ul>
<li class="chapter" data-level="6.1" data-path="Densities.html"><a href="Densities.html#multivariate-normal-distributions"><i class="fa fa-check"></i><b>6.1</b> Multivariate normal distributions</a></li>
<li class="chapter" data-level="6.2" data-path="Densities.html"><a href="Densities.html#autoregressive-processes"><i class="fa fa-check"></i><b>6.2</b> Autoregressive processes</a></li>
<li class="chapter" data-level="6.3" data-path="Densities.html"><a href="Densities.html#gaussian-markov-random-fields-gmrf"><i class="fa fa-check"></i><b>6.3</b> Gaussian Markov random fields (GMRF)</a></li>
<li class="chapter" data-level="6.4" data-path="Densities.html"><a href="Densities.html#separable-construction-of-covariance-precision-matrices"><i class="fa fa-check"></i><b>6.4</b> Separable construction of covariance (precision) matrices</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Examples.html"><a href="Examples.html"><i class="fa fa-check"></i><b>7</b> Example collection</a>
<ul>
<li class="chapter" data-level="7.1" data-path="Examples.html"><a href="Examples.html#example-overview"><i class="fa fa-check"></i><b>7.1</b> Example overview</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="Errors.html"><a href="Errors.html"><i class="fa fa-check"></i><b>8</b> Compilation and run time errors</a>
<ul>
<li class="chapter" data-level="8.1" data-path="Errors.html"><a href="Errors.html#compilation-errors"><i class="fa fa-check"></i><b>8.1</b> Compilation errors</a></li>
<li class="chapter" data-level="8.2" data-path="Errors.html"><a href="Errors.html#run-time-errors"><i class="fa fa-check"></i><b>8.2</b> Run time errors</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="Errors.html"><a href="Errors.html#out-of-bounds-error"><i class="fa fa-check"></i><b>8.2.1</b> Out-of-bounds error</a></li>
<li class="chapter" data-level="8.2.2" data-path="Errors.html"><a href="Errors.html#floating-point-exception"><i class="fa fa-check"></i><b>8.2.2</b> Floating point exception</a></li>
<li class="chapter" data-level="8.2.3" data-path="Errors.html"><a href="Errors.html#missing-casts-for-vectorized-functions"><i class="fa fa-check"></i><b>8.2.3</b> Missing casts for vectorized functions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Toolbox.html"><a href="Toolbox.html"><i class="fa fa-check"></i><b>9</b> Toolbox</a>
<ul>
<li class="chapter" data-level="9.0.1" data-path="Toolbox.html"><a href="Toolbox.html#non-normal-latent-variables-random-effects"><i class="fa fa-check"></i><b>9.0.1</b> Non-normal latent variables (random effects)</a></li>
<li class="chapter" data-level="9.0.2" data-path="Toolbox.html"><a href="Toolbox.html#discrete-latent-variables"><i class="fa fa-check"></i><b>9.0.2</b> Discrete latent variables</a></li>
<li class="chapter" data-level="9.0.3" data-path="Toolbox.html"><a href="Toolbox.html#mixture-models"><i class="fa fa-check"></i><b>9.0.3</b> Mixture models</a></li>
<li class="chapter" data-level="9.0.4" data-path="Toolbox.html"><a href="Toolbox.html#time-series"><i class="fa fa-check"></i><b>9.0.4</b> Time series</a></li>
<li class="chapter" data-level="9.0.5" data-path="Toolbox.html"><a href="Toolbox.html#spatial-models"><i class="fa fa-check"></i><b>9.0.5</b> Spatial models</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="CppTutorial.html"><a href="CppTutorial.html"><i class="fa fa-check"></i><b>10</b> C++ tutorial</a>
<ul>
<li class="chapter" data-level="10.0.1" data-path="CppTutorial.html"><a href="CppTutorial.html#i-know-r-but-not-c"><i class="fa fa-check"></i><b>10.0.1</b> I know R but not C++</a></li>
<li class="chapter" data-level="10.0.2" data-path="CppTutorial.html"><a href="CppTutorial.html#i-know-c"><i class="fa fa-check"></i><b>10.0.2</b> I know C++</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="ModelObject.html"><a href="ModelObject.html"><i class="fa fa-check"></i><b>11</b> Model object</a></li>
<li class="chapter" data-level="12" data-path="Sparsity.html"><a href="Sparsity.html"><i class="fa fa-check"></i><b>12</b> Sparsity</a>
<ul>
<li class="chapter" data-level="12.1" data-path="Sparsity.html"><a href="Sparsity.html#conditional-independence-graphs-and-dags"><i class="fa fa-check"></i><b>12.1</b> Conditional independence graphs and DAGs</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="Sparsity.html"><a href="Sparsity.html#conditional-independence"><i class="fa fa-check"></i><b>12.1.1</b> Conditional independence</a></li>
<li class="chapter" data-level="12.1.2" data-path="Sparsity.html"><a href="Sparsity.html#node-removal-properties"><i class="fa fa-check"></i><b>12.1.2</b> Node removal properties</a></li>
<li class="chapter" data-level="12.1.3" data-path="Sparsity.html"><a href="Sparsity.html#directed-acyclic-graph"><i class="fa fa-check"></i><b>12.1.3</b> Directed acyclic graph</a></li>
<li class="chapter" data-level="12.1.4" data-path="Sparsity.html"><a href="Sparsity.html#the-effect-of-adding-data"><i class="fa fa-check"></i><b>12.1.4</b> The effect of adding data</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="Sparsity.html"><a href="Sparsity.html#the-theta-logistic-example"><i class="fa fa-check"></i><b>12.2</b> The theta logistic example</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="Simulation.html"><a href="Simulation.html"><i class="fa fa-check"></i><b>13</b> Simulation</a>
<ul>
<li class="chapter" data-level="13.1" data-path="Simulation.html"><a href="Simulation.html#overview-of-simulation-methods-in-tmb"><i class="fa fa-check"></i><b>13.1</b> Overview of simulation methods in TMB</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="Simulation.html"><a href="Simulation.html#standard-generators"><i class="fa fa-check"></i><b>13.1.1</b> Standard generators</a></li>
<li class="chapter" data-level="13.1.2" data-path="Simulation.html"><a href="Simulation.html#generators-for-density-objects"><i class="fa fa-check"></i><b>13.1.2</b> Generators for density objects</a></li>
<li class="chapter" data-level="13.1.3" data-path="Simulation.html"><a href="Simulation.html#controlling-the-random-seed"><i class="fa fa-check"></i><b>13.1.3</b> Controlling the random seed</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="Simulation.html"><a href="Simulation.html#simulation-blocks"><i class="fa fa-check"></i><b>13.2</b> Simulation blocks</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="Simulation.html"><a href="Simulation.html#a-linear-regression-example"><i class="fa fa-check"></i><b>13.2.1</b> A linear regression example</a></li>
<li class="chapter" data-level="13.2.2" data-path="Simulation.html"><a href="Simulation.html#a-simulation-study"><i class="fa fa-check"></i><b>13.2.2</b> A simulation study</a></li>
<li class="chapter" data-level="13.2.3" data-path="Simulation.html"><a href="Simulation.html#advanced-examples"><i class="fa fa-check"></i><b>13.2.3</b> Advanced examples</a></li>
<li class="chapter" data-level="13.2.4" data-path="Simulation.html"><a href="Simulation.html#further-notes"><i class="fa fa-check"></i><b>13.2.4</b> Further notes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="Validation.html"><a href="Validation.html"><i class="fa fa-check"></i><b>14</b> Validation</a>
<ul>
<li class="chapter" data-level="14.1" data-path="Validation.html"><a href="Validation.html#residuals"><i class="fa fa-check"></i><b>14.1</b> Residuals</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="Validation.html"><a href="Validation.html#models-without-random-effects"><i class="fa fa-check"></i><b>14.1.1</b> Models without random effects</a></li>
<li class="chapter" data-level="14.1.2" data-path="Validation.html"><a href="Validation.html#models-with-random-effects"><i class="fa fa-check"></i><b>14.1.2</b> Models with random effects</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="Validation.html"><a href="Validation.html#checking-the-laplace-approximation"><i class="fa fa-check"></i><b>14.2</b> Checking the Laplace approximation</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html"><i class="fa fa-check"></i><b>15</b> Atomic functions</a>
<ul>
<li class="chapter" data-level="15.1" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#reverse-mode-differentiation"><i class="fa fa-check"></i><b>15.1</b> Reverse mode differentiation</a></li>
<li class="chapter" data-level="15.2" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#example-adding-new-primitive-function-with-known-derivatives"><i class="fa fa-check"></i><b>15.2</b> Example: Adding new primitive function with known derivatives</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#testing-the-primitive-function"><i class="fa fa-check"></i><b>15.2.1</b> Testing the primitive function</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="AtomicFunctions.html"><a href="AtomicFunctions.html#other-approaches"><i class="fa fa-check"></i><b>15.3</b> Other approaches</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="Appendix.html"><a href="Appendix.html"><i class="fa fa-check"></i><b>16</b> Appendix</a>
<ul>
<li class="chapter" data-level="16.1" data-path="Appendix.html"><a href="Appendix.html#notation"><i class="fa fa-check"></i><b>16.1</b> Notation</a></li>
<li class="chapter" data-level="16.2" data-path="Appendix.html"><a href="Appendix.html#profiling-the-inner-problem"><i class="fa fa-check"></i><b>16.2</b> Profiling the inner problem</a>
<ul>
<li class="chapter" data-level="16.2.1" data-path="Appendix.html"><a href="Appendix.html#example"><i class="fa fa-check"></i><b>16.2.1</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="16.3" data-path="Appendix.html"><a href="Appendix.html#theory-underlying-sdreport"><i class="fa fa-check"></i><b>16.3</b> Theory underlying sdreport</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The comprehensive TMB documentation</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="AtomicFunctions" class="section level1 hasAnchor" number="15">
<h1><span class="header-section-number">15</span> Atomic functions<a href="AtomicFunctions.html#AtomicFunctions" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Custom functions and derivatives can be added to the TMB library. This may be necessary for the following reasons:</p>
<ul>
<li>Adaptive (e.g. iterative) algorithms cannot be represented by a fixed computational graph and thus cannot be directly differentiated using TMB. Algorithms that use parameter dependent if-else branching are examples of such functions.</li>
<li>Some functions have so many floating point operations that it is infeasible to expand the computational graph. Memory usage may be greatly reduced in such cases by collapsing the computational graph to a singe node with multiple inputs and outputs.</li>
</ul>
<div id="reverse-mode-differentiation" class="section level2 hasAnchor" number="15.1">
<h2><span class="header-section-number">15.1</span> Reverse mode differentiation<a href="AtomicFunctions.html#reverse-mode-differentiation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>TMB uses CppAD as its engine for reverse mode derivatives. In order to add a new primitive function</p>
<p><span class="math display">\[f: R^n \rightarrow R^m\]</span></p>
<p>we must inform CppAD how to calculate derivatives of this function in reverse mode. That is, for any range space vector <span class="math inline">\(w \in R^m\)</span> we must calculate the gradient of the function <span class="math inline">\(R^n \rightarrow R\)</span> given by</p>
<p><span class="math display">\[ x \rightarrow \text{sum}( f(x) \odot w ) \]</span></p>
<p>where ‘<span class="math inline">\(\odot\)</span>’ is pointwise multiplication.</p>
</div>
<div id="example-adding-new-primitive-function-with-known-derivatives" class="section level2 hasAnchor" number="15.2">
<h2><span class="header-section-number">15.2</span> Example: Adding new primitive function with known derivatives<a href="AtomicFunctions.html#example-adding-new-primitive-function-with-known-derivatives" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As an example consider the <a href="https://en.wikipedia.org/wiki/Lambert_W_function">Lambert W function</a> defined implicitly by</p>
<p><span class="math display">\[y = W(y e^y)\]</span></p>
<p>Here, we only consider <span class="math inline">\(W\)</span> as defined on the positive reals. It follows, by differentiating the above identity, that</p>
<p><span class="math display">\[ W&#39;(x) = \frac{1}{ \exp\left(W(x)\right) \left(1 + W(x)\right) } \]</span></p>
<p>When coding reverse-mode derivatives we can assume that the function value <span class="math inline">\(W(x)\)</span> has already been computed during a forward pass. For efficiency reasons we should use this intermediate calculation rather than re-calculating <span class="math inline">\(W(x)\)</span> in the reverse pass.</p>
<p>We’ll assume that a plain C++ function (taking double types as input/output) is available to calculate <span class="math inline">\(W(x)\)</span>. It doesn’t matter whether you have the source code of an implementation or just the header with linkage to an external library:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb53-1"><a href="AtomicFunctions.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> LambertW(<span class="dt">double</span> <a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>);</span></code></pre></div>
<p>The macro <code><a class="code" href="../group__macros.html#ga456208023a75e7f193b5af7eb0090781">TMB_ATOMIC_VECTOR_FUNCTION</a>()</code> is used to declare our new primitive Lambert <span class="math inline">\(W\)</span> function:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb54-1"><a href="AtomicFunctions.html#cb54-1" aria-hidden="true" tabindex="-1"></a><a class="code" href="../group__macros.html#ga456208023a75e7f193b5af7eb0090781">TMB_ATOMIC_VECTOR_FUNCTION</a>(</span>
<span id="cb54-2"><a href="AtomicFunctions.html#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ATOMIC_NAME</span></span>
<span id="cb54-3"><a href="AtomicFunctions.html#cb54-3" aria-hidden="true" tabindex="-1"></a>    LambertW</span>
<span id="cb54-4"><a href="AtomicFunctions.html#cb54-4" aria-hidden="true" tabindex="-1"></a>    ,</span>
<span id="cb54-5"><a href="AtomicFunctions.html#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// OUTPUT_DIM</span></span>
<span id="cb54-6"><a href="AtomicFunctions.html#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb54-7"><a href="AtomicFunctions.html#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ATOMIC_DOUBLE</span></span>
<span id="cb54-8"><a href="AtomicFunctions.html#cb54-8" aria-hidden="true" tabindex="-1"></a>    ty[<span class="dv">0</span>] = LambertW(tx[<span class="dv">0</span>]); <span class="co">// Call the &#39;double&#39; version</span></span>
<span id="cb54-9"><a href="AtomicFunctions.html#cb54-9" aria-hidden="true" tabindex="-1"></a>    ,</span>
<span id="cb54-10"><a href="AtomicFunctions.html#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ATOMIC_REVERSE</span></span>
<span id="cb54-11"><a href="AtomicFunctions.html#cb54-11" aria-hidden="true" tabindex="-1"></a>    Type W  = ty[<span class="dv">0</span>];                    <span class="co">// Function value from forward pass</span></span>
<span id="cb54-12"><a href="AtomicFunctions.html#cb54-12" aria-hidden="true" tabindex="-1"></a>    Type DW = <span class="fl">1.</span> / (exp(W) * (<span class="fl">1.</span> + W)); <span class="co">// Derivative</span></span>
<span id="cb54-13"><a href="AtomicFunctions.html#cb54-13" aria-hidden="true" tabindex="-1"></a>    px[<span class="dv">0</span>] = DW * py[<span class="dv">0</span>];                 <span class="co">// Reverse mode chain rule</span></span>
<span id="cb54-14"><a href="AtomicFunctions.html#cb54-14" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s explain in detail what is going on. The macro takes four arguments:</p>
<ol style="list-style-type: decimal">
<li><code>ATOMIC_NAME</code>: Name of new primitive function taking <code><a class="code" href="../namespaceCppAD.html">CppAD</a>::vector</code> as input and output.</li>
<li><code>OUTPUT_DIM</code>: Dimension of the <code><a class="code" href="../namespaceCppAD.html">CppAD</a>::vector</code> which is the function output.</li>
<li><code>ATOMIC_DOUBLE</code>: Specifies how to evaluate the primitive function for the ordinary double type. <code>tx</code> denotes the input vector and <code>ty</code> the output vector of the function <span class="math inline">\(f: R^n \rightarrow R^m\)</span>. In this case both have dimension one.</li>
<li><code>ATOMIC_REVERSE</code>: How to calculate the reverse mode derivatives for a general <code>Type</code>. Again <code>tx</code> and <code>ty</code> denote function input and output but now <code>ty</code> has been computed and is available as an intermediate value. The vectors <code>px</code> and <code>py</code> denote partial derivatives of the end result with respect to <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> respectively. <code>py</code> is given and we must calculate <code>px</code> using the chain rule. This first order derivative rule is automatically expanded up to higher orders required when using TMB’s random effects calculations.</li>
</ol>
<p>To make the function work like other TMB functions it is convenient to define scalar and a vectorized versions that call the atomic function:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb55-1"><a href="AtomicFunctions.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Scalar version</span></span>
<span id="cb55-2"><a href="AtomicFunctions.html#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb55-3"><a href="AtomicFunctions.html#cb55-3" aria-hidden="true" tabindex="-1"></a>Type LambertW(Type <a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>){</span>
<span id="cb55-4"><a href="AtomicFunctions.html#cb55-4" aria-hidden="true" tabindex="-1"></a>  <a class="code" href="../namespaceCppAD.html">CppAD</a>::<a class="code" href="../structvector.html">vector</a>&lt;Type&gt; tx(<span class="dv">1</span>);</span>
<span id="cb55-5"><a href="AtomicFunctions.html#cb55-5" aria-hidden="true" tabindex="-1"></a>  tx[<span class="dv">0</span>] = <a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>;</span>
<span id="cb55-6"><a href="AtomicFunctions.html#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> LambertW(tx)[<span class="dv">0</span>];</span>
<span id="cb55-7"><a href="AtomicFunctions.html#cb55-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-8"><a href="AtomicFunctions.html#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="AtomicFunctions.html#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Vectorized version</span></span>
<span id="cb55-10"><a href="AtomicFunctions.html#cb55-10" aria-hidden="true" tabindex="-1"></a>VECTORIZE_1t(LambertW)</span></code></pre></div>
<div id="testing-the-primitive-function" class="section level3 hasAnchor" number="15.2.1">
<h3><span class="header-section-number">15.2.1</span> Testing the primitive function<a href="AtomicFunctions.html#testing-the-primitive-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here is a complete example using Newton’s method to calculate the Lambert <span class="math inline">\(W\)</span> function
(there are more sophisticated algorithms such as the one by <a href="https://doi.org/10.1016/j.cam.2012.11.021">Fukushima (2013)</a>,
but that doesn’t matter for this example):</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb56-1"><a href="AtomicFunctions.html#cb56-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-2"><a href="AtomicFunctions.html#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;<a class="code" href="../TMB_8hpp.html">TMB.hpp</a>&gt;</span></span>
<span id="cb56-3"><a href="AtomicFunctions.html#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="AtomicFunctions.html#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Double version of Lambert W function</span></span>
<span id="cb56-5"><a href="AtomicFunctions.html#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> LambertW(<span class="dt">double</span> <a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>) {</span>
<span id="cb56-6"><a href="AtomicFunctions.html#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> logx = log(<a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>);</span>
<span id="cb56-7"><a href="AtomicFunctions.html#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> y = (logx &gt; <span class="dv">0</span> ? logx : <span class="dv">0</span>);</span>
<span id="cb56-8"><a href="AtomicFunctions.html#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> niter = <span class="dv">100</span>, i=<span class="dv">0</span>;</span>
<span id="cb56-9"><a href="AtomicFunctions.html#cb56-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (; i &lt; niter; i++) {</span>
<span id="cb56-10"><a href="AtomicFunctions.html#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ( fabs( logx - log(y) - y) &lt; <span class="fl">1e-9</span>) <span class="cf">break</span>;</span>
<span id="cb56-11"><a href="AtomicFunctions.html#cb56-11" aria-hidden="true" tabindex="-1"></a>    y -= (y - exp(logx - y)) / (<span class="dv">1</span> + y);</span>
<span id="cb56-12"><a href="AtomicFunctions.html#cb56-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb56-13"><a href="AtomicFunctions.html#cb56-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i == niter) Rf_warning(<span class="st">&quot;W: failed convergence&quot;</span>);</span>
<span id="cb56-14"><a href="AtomicFunctions.html#cb56-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> y;</span>
<span id="cb56-15"><a href="AtomicFunctions.html#cb56-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-16"><a href="AtomicFunctions.html#cb56-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-17"><a href="AtomicFunctions.html#cb56-17" aria-hidden="true" tabindex="-1"></a><a class="code" href="../group__macros.html#ga456208023a75e7f193b5af7eb0090781">TMB_ATOMIC_VECTOR_FUNCTION</a>(</span>
<span id="cb56-18"><a href="AtomicFunctions.html#cb56-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ATOMIC_NAME</span></span>
<span id="cb56-19"><a href="AtomicFunctions.html#cb56-19" aria-hidden="true" tabindex="-1"></a>    LambertW</span>
<span id="cb56-20"><a href="AtomicFunctions.html#cb56-20" aria-hidden="true" tabindex="-1"></a>    ,</span>
<span id="cb56-21"><a href="AtomicFunctions.html#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// OUTPUT_DIM</span></span>
<span id="cb56-22"><a href="AtomicFunctions.html#cb56-22" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb56-23"><a href="AtomicFunctions.html#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ATOMIC_DOUBLE</span></span>
<span id="cb56-24"><a href="AtomicFunctions.html#cb56-24" aria-hidden="true" tabindex="-1"></a>    ty[<span class="dv">0</span>] = LambertW(tx[<span class="dv">0</span>]); <span class="co">// Call the &#39;double&#39; version</span></span>
<span id="cb56-25"><a href="AtomicFunctions.html#cb56-25" aria-hidden="true" tabindex="-1"></a>    ,</span>
<span id="cb56-26"><a href="AtomicFunctions.html#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ATOMIC_REVERSE</span></span>
<span id="cb56-27"><a href="AtomicFunctions.html#cb56-27" aria-hidden="true" tabindex="-1"></a>    Type W  = ty[<span class="dv">0</span>];                    <span class="co">// Function value from forward pass</span></span>
<span id="cb56-28"><a href="AtomicFunctions.html#cb56-28" aria-hidden="true" tabindex="-1"></a>    Type DW = <span class="fl">1.</span> / (exp(W) * (<span class="fl">1.</span> + W)); <span class="co">// Derivative</span></span>
<span id="cb56-29"><a href="AtomicFunctions.html#cb56-29" aria-hidden="true" tabindex="-1"></a>    px[<span class="dv">0</span>] = DW * py[<span class="dv">0</span>];                 <span class="co">// Reverse mode chain rule</span></span>
<span id="cb56-30"><a href="AtomicFunctions.html#cb56-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-31"><a href="AtomicFunctions.html#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="AtomicFunctions.html#cb56-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Scalar version</span></span>
<span id="cb56-33"><a href="AtomicFunctions.html#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb56-34"><a href="AtomicFunctions.html#cb56-34" aria-hidden="true" tabindex="-1"></a>Type LambertW(Type <a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>){</span>
<span id="cb56-35"><a href="AtomicFunctions.html#cb56-35" aria-hidden="true" tabindex="-1"></a>  <a class="code" href="../namespaceCppAD.html">CppAD</a>::<a class="code" href="../structvector.html">vector</a>&lt;Type&gt; tx(<span class="dv">1</span>);</span>
<span id="cb56-36"><a href="AtomicFunctions.html#cb56-36" aria-hidden="true" tabindex="-1"></a>  tx[<span class="dv">0</span>] = <a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>;</span>
<span id="cb56-37"><a href="AtomicFunctions.html#cb56-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> LambertW(tx)[<span class="dv">0</span>];</span>
<span id="cb56-38"><a href="AtomicFunctions.html#cb56-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-39"><a href="AtomicFunctions.html#cb56-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-40"><a href="AtomicFunctions.html#cb56-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Vectorized version</span></span>
<span id="cb56-41"><a href="AtomicFunctions.html#cb56-41" aria-hidden="true" tabindex="-1"></a><span class="dt">VECTORIZE1_t</span>(LambertW)</span>
<span id="cb56-42"><a href="AtomicFunctions.html#cb56-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-43"><a href="AtomicFunctions.html#cb56-43" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span>&lt;<span class="kw">class</span> Type&gt;</span>
<span id="cb56-44"><a href="AtomicFunctions.html#cb56-44" aria-hidden="true" tabindex="-1"></a>Type objective_function&lt;Type&gt;::<span class="kw">operator</span>() ()</span>
<span id="cb56-45"><a href="AtomicFunctions.html#cb56-45" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb56-46"><a href="AtomicFunctions.html#cb56-46" aria-hidden="true" tabindex="-1"></a>  <a class="code" href="../group__macros.html#ga6b8a70eeee38fe896e89e0a9c6bef84a">PARAMETER_VECTOR</a>(<a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>);</span>
<span id="cb56-47"><a href="AtomicFunctions.html#cb56-47" aria-hidden="true" tabindex="-1"></a>  Type f = LambertW(<a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>).<a class="code" href="../convenience_8hpp.html#a1fe3cb777e8fd8080385579ab87600e3">sum</a>();</span>
<span id="cb56-48"><a href="AtomicFunctions.html#cb56-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> f;</span>
<span id="cb56-49"><a href="AtomicFunctions.html#cb56-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And from R</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="AtomicFunctions.html#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">compile</span>(<span class="st">&quot;lambert.cpp&quot;</span>)</span>
<span id="cb57-2"><a href="AtomicFunctions.html#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dyn.load</span>(<span class="fu">dynlib</span>(<span class="st">&quot;lambert&quot;</span>))</span></code></pre></div>
<div id="checking-function-value-and-derivatives" class="section level4 hasAnchor" number="15.2.1.1">
<h4><span class="header-section-number">15.2.1.1</span> Checking function value and derivatives<a href="AtomicFunctions.html#checking-function-value-and-derivatives" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Check definition of the function:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="AtomicFunctions.html#cb58-1" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">MakeADFun</span>(<span class="at">data=</span><span class="fu">list</span>(), <span class="at">parameters=</span><span class="fu">list</span>(<span class="at"><a class="code" href="../structradix_1_1radix.html#a386883ec22bc6f6d43b5633dd2bdab3f">x</a>=</span><span class="dv">1</span>), <span class="at">DLL=</span><span class="st">&quot;lambert&quot;</span>)</span>
<span id="cb58-2"><a href="AtomicFunctions.html#cb58-2" aria-hidden="true" tabindex="-1"></a>obj<span class="sc">$</span><span class="fu">fn</span>(<span class="dv">7</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="dv">7</span>))</span></code></pre></div>
<pre><code>## [1] 7</code></pre>
<p>Check derivatives using the <code>numDeriv</code> package:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="AtomicFunctions.html#cb60-1" aria-hidden="true" tabindex="-1"></a>numDeriv<span class="sc">::</span><span class="fu">grad</span>(obj<span class="sc">$</span>fn, <span class="dv">7</span>)</span></code></pre></div>
<pre><code>## [1] 0.08626538</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="AtomicFunctions.html#cb62-1" aria-hidden="true" tabindex="-1"></a>obj<span class="sc">$</span><span class="fu">gr</span>(<span class="dv">7</span>)</span></code></pre></div>
<pre><code>##            [,1]
## [1,] 0.08626538</code></pre>
<p>Also try second order derivatives:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="AtomicFunctions.html#cb64-1" aria-hidden="true" tabindex="-1"></a>numDeriv<span class="sc">::</span><span class="fu">hessian</span>(obj<span class="sc">$</span>fn, <span class="dv">7</span>)</span></code></pre></div>
<pre><code>##             [,1]
## [1,] -0.01038959</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="AtomicFunctions.html#cb66-1" aria-hidden="true" tabindex="-1"></a>obj<span class="sc">$</span><span class="fu">he</span>(<span class="dv">7</span>)</span></code></pre></div>
<pre><code>##             [,1]
## [1,] -0.01038969</code></pre>
</div>
</div>
</div>
<div id="other-approaches" class="section level2 hasAnchor" number="15.3">
<h2><span class="header-section-number">15.3</span> Other approaches<a href="AtomicFunctions.html#other-approaches" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For the Lambert <span class="math inline">\(W\)</span> function we know how to calculate the derivatives. There are cases for which the derivatives are impossible (or difficult) to write down. If you’re in this situation you may want to try using forward mode AD to help in defining an atomic function. A full worked out example is available here: <a href="../adaptive_integration_8cpp-example.html">adaptive_integration.cpp</a>. Derivatives are calculated automatically and if-else branching is allowed. The main downside with this approach is that it is limited to functions with very few inputs.</p>
<p>Checkpointing is another useful technique. It is demonstrated in the example <a href="../register_atomic_8cpp-example.html">register_atomic.cpp</a>. It does not work for adaptive algorithms but is otherwise automatic. It is useful to reduce AD memory usage in cases where the same sequence of operations is being applied many times.</p>


</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Validation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Appendix.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
