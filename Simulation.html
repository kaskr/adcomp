<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TMB Documentation: Simulation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TMB Documentation
   &#160;<span id="projectnumber">v1.9.5</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Simulation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>When building models in TMB it is generally recommended to test the implementation on simulated data. Obviously, data can be simulated from R and passed to the C++ template. In practice this amounts to implementing the model twice and is thus a strong way to validate the implementation of the model. However, with increased model complexity it becomes inconvenient to maintain two separate implementations. Therefore, TMB allows the the user to write the simulation code as an integrated part of the C++ model template.</p>
<h2>Overview of simulation methods in TMB</h2>
<h3>Standard generators</h3>
<p>The TMB simulation routines use the same naming convention as the R simulators. For instance <code><a class="el" href="distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c" title="Simulate from a normal distribution. ">rnorm()</a></code> is used to simulate from a normal distribution. However, the argument convention is slightly different:</p>
<ol type="1">
<li><code>rnorm(n, mu, sd)</code> draws <code>n</code> simulations from a normal distribution. Unlike R this works for <b>scalar parameters only</b>.</li>
<li><code>rnorm(mu, sd)</code> is a TMB specific variant that works for <b>mixed scalar and vector input</b>. Output length follows the length of the longest input (no re-cycling) hence is consistent with <code>dnorm(mu, sd)</code>.</li>
</ol>
<p>Currently the following simulators are implemented:</p>
<blockquote class="doxtable">
<p><code><a class="el" href="distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c" title="Simulate from a normal distribution. ">rnorm()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e" title="Simulate from a Poisson distribution. ">rpois()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a6bba21a2132e3504e183cdcd3e3e30cd" title="Simulate from a uniform distribution. ">runif()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a29a4e821ec4b62567f8b40ab6ae78187" title="Simulate from a binomial distribution. ">rbinom()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a74162523131288cf49a0d5d2e7c55253" title="Simulate from a gamma distribution. ">rgamma()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#ae83ce74738a3b97e3432225a9036c99a" title="Simulate from an exponential distribution. ">rexp()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#ae5f4590feabf617af4f525518b5802b8" title="Simulate from a beta distribution. ">rbeta()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#afc356ef7a9514c2629dd14de76e7e265" title="Simulate from an F distribution. ">rf()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a266f56242a3cae0326439727b9f20b47" title="Simulate from a logistic distribution. ">rlogis()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#af610012a7bedea646cc43a7dff276639" title="Simulate from a Student&#39;s t distribution. ">rt()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a2f3b0e14bca65b9153d89e797bdc37dd" title="Simulate from a Weibull distribution. ">rweibull()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#a6b70740b28883180856ab723d264c12a" title="Simulate from a Conway-Maxwell-Poisson distribution. ">rcompois()</a></code>, <code><a class="el" href="distributions__R_8hpp.html#ada07d8e0e57f901b42640684c3b3d2c3" title="Simulate from tweedie distribution. ">rtweedie()</a></code>, <code><a class="el" href="lgamma_8hpp.html#a37ea00b66863cc66e267cfc5ced6c9ee" title="Simulate from a negative binomial distribution. ">rnbinom()</a></code>, <code><a class="el" href="lgamma_8hpp.html#abbdff2745abaa2784b9350f1db929c3e" title="Simulate from a negative binomial distribution. ">rnbinom2()</a></code> </p>
</blockquote>
<h3>Generators for density objects</h3>
<p>Objects from the density namespace have their own <code>simulate()</code> method. Taking the multivariate normal distribution as example we have the following ways to draw a simulation:</p>
<ol type="1">
<li><code>MVNORM(Sigma).simulate()</code> returns a vector with a simulation from the multivariate normal distribution. The void argument version is only available when there is no ambiguity in the dimension of the output. In the <code>MVNORM</code> case the dimension of the output is known from the dimension of <code>Sigma</code>. In other cases e.g. <code>AR1(phi)</code> the dimension of the output is not known hence the void argument version is not available.</li>
<li><code>MVNORM(Sigma).simulate(x)</code> pass <code>x</code> by reference and writes the simulation directly to <code>x</code> without returning anything. This version is available for <em>all</em> the classes because the dimension of the simulation can always be deduced from <code>x</code>.</li>
</ol>
<h3>Controlling the random seed</h3>
<p>All TMB simulation methods are based on R's random number generator. It follows that the random seed can be controlled from R the usual way using <code>set.seed</code> even though the simulation is performed on the C++ side.</p>
<h2>Simulation blocks</h2>
<p>Simulation functions can be called from anywhere in the C++ program. However, usually one should put the simulation code inside specialized <em>simulation blocks</em> that allows the code to only be executed when requested from R.</p>
<h3>A linear regression example</h3>
<p>A complete example extending the example <a class="el" href="linreg_8cpp-example.html">linreg.cpp</a> with simulation code is:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="TMB_8hpp.html">TMB.hpp</a>&gt;</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Type&gt;</div><div class="line">Type objective_function&lt;Type&gt;::operator() ()</div><div class="line">{</div><div class="line">  <a class="code" href="group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(y);</div><div class="line">  <a class="code" href="group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(x);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(a);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(b);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(sd);</div><div class="line">  <a class="code" href="structvector.html">vector&lt;Type&gt;</a> mu = a + b * x;</div><div class="line">  Type nll = -<a class="code" href="convenience_8hpp.html#a1fe3cb777e8fd8080385579ab87600e3">sum</a>(<a class="code" href="group__R__style__distribution.html#ga5eb914782c488bd3ec4a50d4e4a73394">dnorm</a>(y, mu, sd, <span class="keyword">true</span>));</div><div class="line">  <a class="code" href="group__macros.html#ga6c7c2eba6072ba55386fe72bc49604e2">SIMULATE</a> {</div><div class="line">    y = <a class="code" href="distributions__R_8hpp.html#a6827b210cb379b7d9a8c23eafdf7e64c">rnorm</a>(mu, sd);  <span class="comment">// Simulate response</span></div><div class="line">    <a class="code" href="group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(y);          <span class="comment">// Report the simulation</span></div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> nll;</div><div class="line">}</div></div><!-- fragment --><blockquote class="doxtable">
<p>The <code>SIMULATE</code> block marks the simulation and is not executed by default. </p>
</blockquote>
<p>We compile the C++-file and the model object is constructed as usual:</p>
<div class="fragment"><div class="line">obj &lt;- MakeADFun(data, parameters, DLL=&quot;linreg&quot;)</div></div><!-- fragment --><p>Now a simulation can be generated with</p>
<div class="fragment"><div class="line">set.seed(1) ## optional</div><div class="line">obj$simulate()</div></div><!-- fragment --><div class="fragment"><div class="line">## $y</div><div class="line">##  [1] -0.6264538  0.1836433 -0.8356286  1.5952808  0.3295078 -0.8204684</div><div class="line">##  [7]  0.4874291  0.7383247  0.5757814 -0.3053884</div></div><!-- fragment --><p>This only includes the simulated response - not the rest of the data. A complete dataset can be generated by:</p>
<div class="fragment"><div class="line">set.seed(1) ## optional - Note: same y as previous</div><div class="line">obj$simulate(complete=TRUE)</div></div><!-- fragment --><div class="fragment"><div class="line">## $y</div><div class="line">##  [1] -0.6264538  0.1836433 -0.8356286  1.5952808  0.3295078 -0.8204684</div><div class="line">##  [7]  0.4874291  0.7383247  0.5757814 -0.3053884</div><div class="line">## </div><div class="line">## $x</div><div class="line">##  [1]  1  2  3  4  5  6  7  8  9 10</div><div class="line">## </div><div class="line">## attr(,&quot;check.passed&quot;)</div><div class="line">## [1] TRUE</div></div><!-- fragment --><p>Here we did not explicitely state the parameter values to use with the simulation. The <code>simulate</code> method takes an additional argument <code>par</code> that can be used for this.</p>
<blockquote class="doxtable">
<p>The default parameter values used for the simulation is <code>obj$env$last.par</code>. </p>
</blockquote>
<h3>A simulation study</h3>
<p>Simulating datasets from known parameters and re-estimationg those parameters can be done generically by:</p>
<div class="fragment"><div class="line">sim &lt;- replicate(50, {</div><div class="line">  simdata &lt;- obj$simulate(par=obj$par, complete=TRUE)</div><div class="line">  obj2 &lt;- MakeADFun(simdata, parameters, DLL=&quot;linreg&quot;, silent=TRUE)</div><div class="line">  nlminb(obj2$par, obj2$fn, obj2$gr)$par</div><div class="line">})</div></div><!-- fragment --><p>We reshape and plot the result:</p>
<div class="fragment"><div class="line">library(lattice)</div><div class="line">df &lt;- data.frame(estimate=as.vector(sim), parameter=names(obj$par)[row(sim)])</div><div class="line">densityplot( ~ estimate | parameter, data=df, layout=c(3,1))</div></div><!-- fragment --><div class="image">
<object type="image/svg+xml" data="figure/unnamed-chunk-9-1.svg" alt="plot of chunk unnamed-chunk-9" style="display: block; margin: auto;"></object>
</div>
<p>Compare with the true parameter values of the simulation:</p>
<div class="fragment"><div class="line">obj$par</div></div><!-- fragment --><div class="fragment"><div class="line">##  a  b sd </div><div class="line">##  0  0  1</div></div><!-- fragment --><h3>Advanced examples</h3>
<p>The examples <a class="el" href="sam_8cpp-example.html">sam.cpp</a> and <a class="el" href="ar1_4D_8cpp-example.html">ar1_4D.cpp</a> includes more advanced simulation code. The latter demonstrates how to simulate from the density objects:</p>
<div class="fragment"><div class="line"><span class="comment">// Separable covariance on 4D lattice with AR1 structure in each direction.</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="TMB_8hpp.html">TMB.hpp</a>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* Parameter transform */</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> Type&gt;</div><div class="line">Type f(Type x){<span class="keywordflow">return</span> Type(2)/(Type(1) + exp(-Type(2) * x)) - Type(1);}</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Type&gt;</div><div class="line">Type objective_function&lt;Type&gt;::operator() ()</div><div class="line">{</div><div class="line">  <a class="code" href="group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(N)</div><div class="line">  <a class="code" href="group__macros.html#ga6ac3eddb1dd503ceaf4c6ac91546b23e">PARAMETER_ARRAY</a>(eta);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(transf_phi); <span class="comment">/* fastest running dim */</span></div><div class="line">  Type phi=f(transf_phi);</div><div class="line">  <a class="code" href="group__macros.html#ga43a13c435127491364e4a167478f4992">ADREPORT</a>(phi);</div><div class="line"></div><div class="line">  using namespace <a class="code" href="namespacedensity.html">density</a>;</div><div class="line">  Type res=0;</div><div class="line"></div><div class="line">  res+=AR1(phi,AR1(phi,AR1(phi,AR1(phi))))(eta);</div><div class="line"></div><div class="line">  <span class="comment">// logdpois = N log lam - lam</span></div><div class="line">  for(<span class="keywordtype">int</span> i=0;i&lt;N.size();i++)res-=N[i]*eta[i]-exp(eta[i]);</div><div class="line"></div><div class="line">  <a class="code" href="group__macros.html#ga6c7c2eba6072ba55386fe72bc49604e2">SIMULATE</a> {</div><div class="line">    AR1(phi,AR1(phi,AR1(phi,AR1(phi)))).simulate(eta);</div><div class="line">    <a class="code" href="structvector.html">vector&lt;Type&gt;</a> lam = exp(eta);</div><div class="line">    N = <a class="code" href="distributions__R_8hpp.html#a9483de78a77e19b579580f0e23f4bb0e">rpois</a>(lam);</div><div class="line">    <a class="code" href="group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(eta);</div><div class="line">    <a class="code" href="group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(N);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> res;</div><div class="line"></div><div class="line">}</div></div><!-- fragment --><p>In this example the 4D-array <code>eta</code> is passed to the simulator by reference. Thereby the simulator knows the dimension of <code>eta</code> and can fill <code>eta</code> with a simulation.</p>
<h3>Further notes</h3>
<p>The above example only used one simulation block. In general there is no limitation on the number of simulation blocks that can be used in a model and simulation blocks can use temporaries calculated outside the blocks (as demonstrated in the linear regression example). For clarity reasons, it is often a good idea to add a simulation block after each likelihood contribution. However, note that simulation blocks are in general <b>not</b> commutative (unlike likelihood accumulation). It is therefore further recommended to add likelihood contributions of random effects in the natural hierarchical order.</p>
<p>Adding simulation code to the model template </p>
</div></div><!-- contents -->
License: <a href="https://gnu.org/licenses/old-licenses/gpl-2.0.txt">GPL v2</a>
