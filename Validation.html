<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TMB Documentation: Validation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">TMB Documentation
   &#160;<span id="projectnumber">v1.9.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Validation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Residuals</h2>
<p>The underlying framework is the same for all cases listed in this section. [ Description of general framework FIXME ]</p>
<p>For models that does not include random effects the calculations can be simplified greatly.</p>
<h3>Models without random effects</h3>
<h4>Normal distribution (Pearson residuals) .</h4>
<p>This example shows how standardized residuals can be calculated within the template code and reported back to R using the <code>REPORT</code> function in TMB. </p><div class="fragment"><div class="line"><span class="comment">// linear regression with reporting of residuals</span></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="TMB_8hpp.html">TMB.hpp</a>&gt;</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Type&gt;</div><div class="line">Type objective_function&lt;Type&gt;::operator() ()</div><div class="line">{</div><div class="line">  <a class="code" href="group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(Y);</div><div class="line">  <a class="code" href="group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(x);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(a);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(b);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(logSigma);</div><div class="line">  Type sigma = exp(logSigma);</div><div class="line">  Vector&lt;Type&gt; pred = a + b*x;</div><div class="line">  Type nll = -<a class="code" href="convenience_8hpp.html#a1fe3cb777e8fd8080385579ab87600e3">sum</a>(<a class="code" href="group__R__style__distribution.html#ga5eb914782c488bd3ec4a50d4e4a73394">dnorm</a>(Y, a+b*x, sigma, <span class="keyword">true</span>));</div><div class="line">  Vector&lt;Type&gt; residuals = (Y - pred)/sigma;  </div><div class="line">  <a class="code" href="group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(residuals);  </div><div class="line">  <span class="keywordflow">return</span> nll;</div><div class="line">}</div></div><!-- fragment --><p> Assuming that the model parameters have been fitted, and the model object is called <code>obj</code>, the standardized residuals can now be extracted from the model object usinig the <code>report()</code> function and inspected for normality as follows:</p>
<div class="fragment"><div class="line">... </div><div class="line">rep &lt;- obj$report()</div><div class="line">qqnorm(rep$residuals)</div><div class="line">abline(0,1)</div></div><!-- fragment --><h4>Non-normal distributions</h4>
<h5>Continuous</h5>
<p>We now consider situations where the error distribution is continuous but not Gaussian. Residuals that are standard normal distributed given that the model is correct, can be obtained be using the "transformation trick", here illustrated using a model that fits a gamma distribution.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="TMB_8hpp.html">TMB.hpp</a>&gt;</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> Type&gt;</div><div class="line">Type objective_function&lt;Type&gt;::operator() ()</div><div class="line">{</div><div class="line">  <a class="code" href="group__macros.html#gad334262a7679f343bdc919ae35810161">DATA_VECTOR</a>(Y);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(shape);</div><div class="line">  <a class="code" href="group__macros.html#ga70b2d449f7c53e87abee7d5fb71dc4c0">PARAMETER</a>(scale);</div><div class="line"></div><div class="line">  Type nll=-<a class="code" href="group__R__style__distribution.html#gab0e2205710a698ad6a0ed39e0652c9a3">dgamma</a>(Y,shape,scale,<span class="keyword">true</span>).sum();</div><div class="line">  <a class="code" href="structvector.html">vector&lt;Type&gt;</a> residuals = <a class="code" href="group__R__style__distribution.html#gafde4381db528cb2e6bf410f9cfcdcb52">qnorm</a>( <a class="code" href="group__R__style__distribution.html#ga3bd06a324f89b21694aac26bfe1aef45">pgamma</a>(Y,shape,scale) );</div><div class="line">  <a class="code" href="group__macros.html#gac2d7888f4e0385930448f992de53079b">REPORT</a>(residuals);</div><div class="line">  <span class="keywordflow">return</span> nll;</div><div class="line">}</div></div><!-- fragment --><h5>Discrete</h5>
<p>For discrete probability distributions the transformation trick can also be used, but an element of randomization must be added in order to obtain residuals that are truly Gaussian.</p>
<p>Assume that you have a series of observed counts <code>y</code> and you have fitted some TMB model using a Poisson likelihood, and the predicted values from that model have been reported and saved in a vector called <code>mu</code>.</p>
<div class="fragment"><div class="line">... </div><div class="line">a &lt;- ppois(y - 1, mu)</div><div class="line">b &lt;- ppois(y, mu)</div><div class="line">u &lt;- runif(n = length(y), min = a, max = b)</div><div class="line">residuals &lt;- qnorm(u)</div></div><!-- fragment --><h3>Models with random effects</h3>
<p>Model validation using residuals is considerably more complicated for random effect models. Further information can be found in [] FIXME: not generating reference.</p>
<h4>One-step-ahead residuals</h4>
<p>Other names are one step prediction errors, forecast pseudo-residuals, and recursive residuals. These residuals can be computed using the <code>oneStepPredict</code> function. There are several methods available within this function, and it is the responsibility of the user to ensure that an appropriate method is chosen for a given model.</p>
<p>The following examples of its use are availabe in the <code>tmb_examples/validation</code> folder.</p>
<table class="doxtable">
<tr>
<th align="left">Example </th><th align="left">Description  </th></tr>
<tr>
<td align="left"><a class="el" href="validation_2MVRandomWalkValidation_8cpp-example.html">validation/MVRandomWalkValidation.cpp</a> </td><td align="left">Estimate and validate a multivariate random walk model with correlated increments and correlated observations. </td></tr>
<tr>
<td align="left"><a class="el" href="validation_2randomwalkvalidation_8cpp-example.html">validation/randomwalkvalidation.cpp</a> </td><td align="left">Estimate and validate a random walk model with and without drift </td></tr>
<tr>
<td align="left"><a class="el" href="validation_2rickervalidation_8cpp-example.html">validation/rickervalidation.cpp</a> </td><td align="left">Estimate and validate a Ricker model based on data simulated from the logistic map </td></tr>
</table>
<h4>One sample from the posterior</h4>
<p>An alternative (and faster) method is based on a single sample of the random effects from the their posterior distribution given the data. For state space models we can derive both process- and observation errors from the single sample and the observations, and compare these with the assumptions in the model.</p>
<p>An example can be found at the end of the <code>randomwalkvalidation.R</code> file in the <code>tmb_examples/validation</code> folder</p>
<h2>Checking the Laplace approximation</h2>
<p>FIXME: </p>
</div></div><!-- contents -->
License: <a href="https://gnu.org/licenses/old-licenses/gpl-2.0.txt">GPL v2</a>
